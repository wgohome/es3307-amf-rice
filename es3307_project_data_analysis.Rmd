---
title: "ES3307 Data Analysis for Project"
author: "William Goh"
date: "10/31/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: show
---

<style type="text/css">
  h3 {
    font-size: 18px;
  }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE,
                      fig.align="center"
                      )
library(tidyverse)
library(lme4)
library(car)
library(gghalves)
library(effects)
library(emmeans)
```

```{r load-data}
rm(list=ls())
rice <- read_csv("rice.csv")
rice$AMF <- factor(rice$AMF)
rice$NIT <- factor(rice$NIT, levels=c(0,1), labels=c("low","high"))
rice$PHOS <- factor(rice$PHOS, levels=c(0,1), labels=c("low","high"))
rice$POT <- factor(rice$POT)
```

## Research Question

> INVESTIGATING IF MYCORRHIZA INOCULATION COULD IMPROVE ORYZA SATIVA CROP YIELD UNDER-NUTRIENT DEPLETED SOIL

## Mock Dataset Generation

The dataset was generated by setting expected means and generating the replicatesâ€™ values from a normal distribution around each mean. To code to generate the dataset is given here: (Unfold code block)

```{r class.source="fold-hide", eval=FALSE}
AMF <- c("Ctrl", "AMF1", "AMF2")
NIT <- c(0, 1)
PHOS <- c(0, 1)
norms <- c(
  65, 70, 75, 90,
  75, 85, 85, 105, 
  95, 105, 110, 130
)

row <- 1
norm_i <- 1
for (a in AMF)
{
  for (b in NIT)
  {
    for (c in PHOS)
    {
      for (i in 1:10) {
        if (row == 1)
        {
          df <- data.frame(POT=row, MASS=rnorm(1, mean=norms[norm_i], sd=5), AMF=a, NIT=b, PHOS=c)
        }
        else
        {
          df[row,] <- list(POT=row, MASS=rnorm(1, mean=norms[norm_i], sd=5), AMF=a, NIT=b, PHOS=c)
        }
        row <- row + 1
      }
      norm_i <- norm_i + 1
    }
  }
}
```


## Data Exploration

The data is visualised in boxplots as shown below. There appears to be clustering of points by AMF treatment levels and the relative MASS for each AMF treatment appears the same across different combinations of NIT and PHOS. But it also appears like NIT and PHOS has some effect on MASS, though this has to be rigorously tested in our data analysis. Therefore, in agreement with our experimental design considerations, three explanatory variables are considered - AMF, NIT and PHOS.


```{r}
ggplot(data=rice, mapping=aes(y=MASS, x=AMF, col=AMF)) +
  geom_boxplot(width=0.3, position=position_nudge(0.25)) +
  geom_half_point(side='l', alpha=0.5,) +
  facet_grid(NIT ~ PHOS, labeller=label_both) +
  theme_bw() +
  labs(x="AMF Treatment", y="Average MASS of seed yield / kg")
```


## Model selection

A linear model is fitted to test for the effects of AMF, NIT and PHOS on MASS.

```{r}
m1 <- lm(MASS ~ AMF * NIT * PHOS, data=rice)
m1
```

```{r}
par(mfrow=c(2,2))
plot(m1)
par(mfrow=c(1,1))
```

The residuals are evenly distributed across the range of fitted values, indicating a linear relationship between the response and explanatory variables. The qq plot shows that the residuals are normally distributed. The scale location plot shows that the standardised residuals are well distributed, indicating approximately equal variance across fitted values. There also appears to be no outlier that might skew the model heavily. The assumptions for a linear model appear to have been met. It is therefore reasonable to fit a linear model. There don't seem to be a need to transform the data as well.

```{r}
# knitr::kable(Anova(m1))
Anova(m1)
```

There model shows no significant interaction between AMF, NIT and PHOS (F~2,108~ = 0.3684, p = 0.6927) and between AMF and PHOS (F~2,108~ = 1.9336, p = 0.1496). Dropping the three way interaction term will give the simplified second model m2.

```{r}
m2 <- lm(MASS ~ AMF + NIT + PHOS + AMF:NIT + AMF:PHOS + NIT:PHOS, data=rice)
# knitr::kable(anova(m1, m2))
anova(m1, m2)
```

Since there is no significant difference between model 1 and model 2 (F~-2,110~ = 0.3684, p = 0.6927), we can use the simpler model m2, which should have more power.

```{r}
# knitr::kable(Anova(m2))
Anova(m2)
```

The interaction term between AMF and NIT is still not significant (F~2,108~ = 1.9561, p = 0.1463). We will then drop this term in model 3.

```{r}
m3 <- lm(MASS ~ AMF + NIT + PHOS + AMF:NIT + NIT:PHOS, data=rice)
# knitr::kable(anova(m2, m3))
anova(m2, m3)
```

Since there is no significant difference between model 2 and model 3 (F~-2,112~ = 1.9561, p = 0.1463), we can use the even simpler model m3.

```{r}
par(mfrow=c(2,2))
plot(m3)
par(mfrow=c(1,1))
```

Re-checking the diagnostic plots show that the earlier assumptions of a linear model still holds.


## Data Analysis

```{r}
# knitr::kable(Anova(m3))
Anova(m3)
```

Running a type 2 Anova on the final linear model shows that the interaction between AMF and NIT (F~2,112~ = 1.9561, p = 0.004576 < 0.01), and also the interaction between NIT and PHOS (F~1,112~ = 42.7376, p < 0.001) significantly explains the variation in MASS of crop yield.

The interaction is visualized in the interaction plot below. 

```{r}
plot(allEffects(m3), multiline=TRUE, ci.style="bars")
```

Higher PHOS and higher NIT appears to cause MASS to increase to a greater extent than if only NIT or PHOS is at high level. This is biologically reasonable as both PHOS and NIT are essential nutrients for plant growth, and they might work together synergistically.

On the other hand, higher NIT levels results in an increase in MASS at all AMF treatment levels. The interaction cannot be clearly seen from the interaction plot. Referring to the Anova of Model 3, the F value of the AMF:NIT interaction term (F~2,112~ = 5.6546) is much lower than the NIT:PHOS interaction term (F~1,112~ = 42.7376).

The effect sizes predicted by the model is plotted below.

```{r}
m3Pred <- emmeans(m3, ~ AMF + NIT + PHOS + AMF:NIT)
m3Pred <- as_tibble(m3Pred)
m3Pred$COMBI <- with(m3Pred, paste("NIT: ", NIT, ", PHOS: ", PHOS, sep=""))
m3Pred$COMBI2 <- with(m3Pred, paste("NIT: ", NIT, ", \nPHOS: ", PHOS, sep=""))

rice$COMBI <- with(rice, paste("NIT: ", NIT, ", PHOS: ", PHOS, sep=""))
rice$COMBI2 <- with(rice, paste("NIT: ", NIT, ", \nPHOS: ", PHOS, sep=""))

ggplot(data=m3Pred) +
  geom_point(
    mapping=aes(y=emmean, x=COMBI2, col=AMF),
    position=position_dodge(width=0.5),
    alpha=0.6
  ) +
  geom_errorbar(
    mapping=aes(ymin=lower.CL, ymax=upper.CL, x=COMBI2, col=AMF),
    position=position_dodge(width=0.5),
    width=0.3, alpha=0.6
  ) +
  geom_point(data=rice, 
    mapping=aes(y=MASS, x=COMBI2, col=AMF),
    position=position_jitterdodge(jitter.width=0.2, dodge.width=0.5),
    size=0.5, alpha=0.3) +
  theme_bw() +
  labs(
    x = "Combination of NIT & PHOS treatment",
    y = "Average MASS of seed yield / kg"
  ) +
  scale_color_discrete(name="AMF Treatment") +
  theme(
    legend.title=element_text(size=9),
    legend.text=element_text(size=7),
    axis.text.x=element_text(angle=90)
  )

ggplot(data=m3Pred) +
  geom_point(
    mapping=aes(y=emmean, x=AMF, col=COMBI),
    position=position_dodge(width=0.6),
    alpha=0.6
  ) +
  geom_errorbar(
    mapping=aes(ymin=lower.CL, ymax=upper.CL, x=AMF, col=COMBI),
    position=position_dodge(width=0.6),
    width=0.3, alpha=0.6
  ) +
  geom_point(data=rice, 
     mapping=aes(y=MASS, x=AMF, col=COMBI),
     position=position_jitterdodge(dodge.width=0.6, jitter.width=0.2),
     size=0.5, alpha=0.3) +
  theme_bw() +
  labs(
    x = "AMF Treatment",
    y = "Average MASS of seed yield / kg"
  ) +
  scale_color_discrete(name="Nutrient Combination") +
  theme(
    legend.text=element_text(size=7)
  )
```

Firstly, our model shows that a combination of both higher nitrogen and phosphate levels can cause the most dramatic increase in mass of seed yield. However, just high nitrogen or just high phosphate does not cause as much of an increase in yield. The significant interaction term between nitrogen and phosphate levels already alluded to this.

Secondly, AMF2 appears to boost yield across all nutrient combinations compared to the control. Interestingly, AMF2 has a stronger effect on increasing yield than AMF1. This suggests that selecting a more suitable species of AMF is important for the goal of increasing rice yield.

Overall, a combination of high nutrients (nitrogen and phosphate), together with AMF inoculation with a strongly compatible species, can optimize yield higher than just a single factor on its own. There is potential for using AMF inoculation to help rice farmers and rice production become more resilient in maximising yield despite increasingly harsher conditions.




